<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown to PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: white;
            --text-primary: #212121;
            --text-secondary: #424242;
            --text-muted: #616161;
            --accent-primary: #1976d2;
            --border-color: #e0e0e0;
            --code-bg: #f5f5f5;
            --code-text: #d32f2f;
            --code-block-bg: #263238;
            --code-block-text: #aed581;
            --shadow: rgba(0,0,0,0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root:not([data-theme="light"]) {
                --bg-primary: #1a1a1a;
                --bg-secondary: #2d2d2d;
                --text-primary: #e0e0e0;
                --text-secondary: #b0b0b0;
                --text-muted: #808080;
                --accent-primary: #64b5f6;
                --border-color: #404040;
                --code-bg: #3d3d3d;
                --code-text: #f48fb1;
                --code-block-bg: #1e1e1e;
                --code-block-text: #a5d6a7;
                --shadow: rgba(0,0,0,0.3);
            }
        }

        :root[data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            --accent-primary: #64b5f6;
            --border-color: #404040;
            --code-bg: #3d3d3d;
            --code-text: #f48fb1;
            --code-block-bg: #1e1e1e;
            --code-block-text: #a5d6a7;
            --shadow: rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            padding: 20px;
            transition: background-color 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .panel {
            background: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .panel-header {
            background: var(--accent-primary);
            color: white;
            padding: 16px 20px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .theme-toggle {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        textarea {
            flex: 1;
            border: none;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: none;
            outline: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .preview-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        #preview {
            padding: 40px;
            background: var(--bg-secondary);
            transition: background-color 0.3s ease;
        }

        button.pdf-btn {
            background: white;
            color: var(--accent-primary);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        button.pdf-btn:hover {
            background: rgba(255,255,255,0.9);
        }

        /* PDF Print Styles - Force light mode for printing */
        @media print {
            :root {
                --bg-primary: white;
                --bg-secondary: white;
                --text-primary: #212121;
                --text-secondary: #424242;
                --text-muted: #616161;
                --accent-primary: #1976d2;
                --border-color: #e0e0e0;
                --code-bg: #f5f5f5;
                --code-text: #d32f2f;
                --code-block-bg: #263238;
                --code-block-text: #aed581;
            }

            body {
                background: white;
                padding: 0;
            }
            .container {
                display: block;
                height: auto;
            }
            .panel {
                box-shadow: none;
                border-radius: 0;
            }
            .panel:first-child,
            .panel-header {
                display: none;
            }
            #preview {
                padding: 20mm;
            }
        }

        /* Markdown Styling - Material Design */
        #preview h1 {
            color: var(--accent-primary);
            font-size: 1.8em;
            font-weight: 500;
            margin-bottom: 0.4em;
            margin-top: 0.5em;
            padding-bottom: 0.2em;
            border-bottom: 2px solid var(--border-color);
            transition: color 0.3s ease, border-color 0.3s ease;
        }

        #preview h2 {
            color: var(--accent-primary);
            font-size: 1.5em;
            font-weight: 500;
            margin-top: 1em;
            margin-bottom: 0.3em;
            padding-bottom: 0.15em;
            border-bottom: 1px solid var(--border-color);
            transition: color 0.3s ease, border-color 0.3s ease;
        }

        #preview h3 {
            color: var(--text-secondary);
            font-size: 1.25em;
            font-weight: 500;
            margin-top: 0.8em;
            margin-bottom: 0.3em;
            transition: color 0.3s ease;
        }

        #preview h4 {
            color: var(--text-secondary);
            font-size: 1.1em;
            font-weight: 500;
            margin-top: 0.6em;
            margin-bottom: 0.3em;
            transition: color 0.3s ease;
        }

        #preview p {
            line-height: 1.5;
            margin-bottom: 0.75em;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        #preview ul, #preview ol {
            margin-bottom: 0.75em;
            padding-left: 2em;
        }

        #preview li {
            line-height: 1.5;
            margin-bottom: 0.3em;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        #preview code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--code-text);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #preview pre {
            background: var(--code-block-bg);
            color: var(--code-block-text);
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 0.75em;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #preview pre code {
            background: none;
            color: inherit;
            padding: 0;
        }

        #preview blockquote {
            border-left: 4px solid var(--accent-primary);
            padding-left: 12px;
            margin: 0.75em 0;
            color: var(--text-muted);
            font-style: italic;
            transition: border-color 0.3s ease, color 0.3s ease;
        }

        #preview table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 0.75em;
        }

        #preview th, #preview td {
            border: 1px solid var(--border-color);
            padding: 8px 10px;
            text-align: left;
            transition: border-color 0.3s ease;
        }

        #preview th {
            background: var(--accent-primary);
            color: white;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        #preview tr:nth-child(even) {
            background: var(--code-bg);
            transition: background-color 0.3s ease;
        }

        #preview a {
            color: var(--accent-primary);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        #preview a:hover {
            text-decoration: underline;
        }

        #preview img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0.75em 0;
        }

        #preview hr {
            border: none;
            border-top: 2px solid var(--border-color);
            margin: 1.5em 0;
            transition: border-color 0.3s ease;
        }

        /* Mermaid diagram styling */
        #preview .mermaid {
            display: flex;
            justify-content: center;
            margin: 1em 0;
        }

        #preview .mermaid svg {
            max-width: 100%;
            height: auto;
        }

        /* Print-specific optimizations for PDF */
        @media print {
            /* Ensure Mermaid diagrams print correctly */
            #preview .mermaid,
            #preview .mermaid svg {
                page-break-inside: avoid;
                break-inside: avoid;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                color-adjust: exact;
            }

            /* Prevent page breaks inside elements to avoid cutting lines in half */
            #preview h1, #preview h2, #preview h3, #preview h4,
            #preview p, #preview li, #preview blockquote,
            #preview pre, #preview tr {
                page-break-inside: avoid;
                break-inside: avoid;
            }

            /* Keep headings with the content that follows them */
            #preview h1, #preview h2, #preview h3, #preview h4 {
                page-break-after: avoid;
                break-after: avoid;
            }

            /* Control orphans and widows (minimum lines at page breaks) */
            #preview p, #preview li {
                orphans: 3;
                widows: 3;
            }

            /* Keep tables together when possible */
            #preview table {
                page-break-inside: avoid;
                break-inside: avoid;
            }

            #preview h1 {
                font-size: 1.5em;
                margin-top: 0.3em;
                margin-bottom: 0.3em;
                padding-bottom: 0.15em;
            }

            #preview h2 {
                font-size: 1.3em;
                margin-top: 0.6em;
                margin-bottom: 0.25em;
                padding-bottom: 0.1em;
            }

            #preview h3 {
                font-size: 1.15em;
                margin-top: 0.5em;
                margin-bottom: 0.25em;
            }

            #preview h4 {
                font-size: 1.05em;
                margin-top: 0.4em;
                margin-bottom: 0.25em;
            }

            #preview p {
                line-height: 1.4;
                margin-bottom: 0.6em;
            }

            #preview ul, #preview ol {
                margin-bottom: 0.6em;
            }

            #preview li {
                line-height: 1.4;
                margin-bottom: 0.2em;
            }

            #preview blockquote {
                margin: 0.6em 0;
            }

            #preview table {
                margin-bottom: 0.6em;
            }

            #preview th, #preview td {
                padding: 6px 8px;
            }

            #preview pre {
                padding: 10px;
                margin-bottom: 0.6em;
            }

            #preview img {
                margin: 0.6em 0;
            }

            #preview hr {
                margin: 1em 0;
            }

            /* Firefox-specific print fixes */
            @-moz-document url-prefix() {
                #preview * {
                    -moz-print-color-adjust: exact;
                }
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel">
            <div class="panel-header">
                <span>Markdown Input</span>
                <button class="theme-toggle" onclick="toggleTheme()">Toggle Dark Mode</button>
            </div>
            <textarea id="markdown" placeholder="Paste your markdown here..."># Technical Documentation

## Overview
This is a sample document to demonstrate the Material Design styling.

### Key Features
- **Clean typography** with proper hierarchy
- *Modern color scheme* inspired by Material Design
- `Code highlighting` for technical content
- Professional table formatting
- **Mermaid diagrams** for flowcharts and visualizations

### Mermaid Diagram Example
```mermaid
graph LR
    A[Markdown Input] --> B[marked.js Parser]
    B --> C[HTML Preview]
    C --> D[Browser Print]
    D --> E[PDF Output]
    style A fill:#1976d2,color:#fff
    style E fill:#1976d2,color:#fff
```

> **Note on Mermaid Diagrams**: Diagrams render perfectly in the browser preview but may not appear in PDF output due to browser print API limitations with dynamic SVG content. For documents requiring diagrams in PDF, consider capturing screenshots of diagrams separately.

### Code Example
```javascript
function hello() {
    console.log("Hello, World!");
}
```

### Data Table
| Feature | Status | Priority |
|---------|--------|----------|
| Authentication | Complete | High |
| API Integration | In Progress | High |
| UI Polish | Planned | Medium |

> **Note**: This template works great for technical documentation, reports, and user guides. Supports Mermaid diagrams for flowcharts, sequence diagrams, and more!

For more information, visit [our website](https://example.com).</textarea>
        </div>

        <div class="panel">
            <div class="panel-header">
                <span>Preview</span>
                <button class="pdf-btn" onclick="downloadPDF()">Download as PDF</button>
            </div>
            <div class="preview-container">
                <div id="preview"></div>
            </div>
        </div>
    </div>

    <script>
        const textarea = document.getElementById('markdown');
        const preview = document.getElementById('preview');

        // Theme management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            } else if (systemPrefersDark) {
                // System prefers dark and no saved preference - let CSS handle it
                document.documentElement.removeAttribute('data-theme');
            } else {
                // System prefers light - no attribute needed
                document.documentElement.removeAttribute('data-theme');
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            let newTheme;
            
            if (currentTheme === 'dark') {
                // Currently dark, switch to light
                newTheme = 'light';
            } else if (currentTheme === 'light') {
                // Currently light, clear preference to follow system
                newTheme = null;
            } else {
                // Following system preference, switch to opposite
                newTheme = systemPrefersDark ? 'light' : 'dark';
            }
            
            if (newTheme) {
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            } else {
                document.documentElement.removeAttribute('data-theme');
                localStorage.removeItem('theme');
            }
            
            // Reinitialize Mermaid with new theme
            initMermaid();
            updatePreview();
        }

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            const savedTheme = localStorage.getItem('theme');
            if (!savedTheme) {
                // Only react to system changes if user hasn't set a preference
                document.documentElement.removeAttribute('data-theme');
                initMermaid();
                updatePreview();
            }
        });

        // Initialize theme on page load
        initTheme();

        // Mermaid configuration
        function getMermaidTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Determine if we should use dark theme
            const isDark = currentTheme === 'dark' || 
                          (currentTheme !== 'light' && systemPrefersDark);
            
            return isDark ? 'dark' : 'default';
        }

        function initMermaid() {
            mermaid.initialize({
                startOnLoad: false,
                theme: getMermaidTheme(),
                securityLevel: 'loose',
                fontFamily: 'Segoe UI, Roboto, Helvetica Neue, Arial, sans-serif'
            });
        }

        initMermaid();

        async function updatePreview() {
            const markdown = textarea.value;
            preview.innerHTML = marked.parse(markdown);
            
            // Render mermaid diagrams - process each code block
            const mermaidBlocks = preview.querySelectorAll('pre code.language-mermaid');
            
            for (let i = 0; i < mermaidBlocks.length; i++) {
                const codeBlock = mermaidBlocks[i];
                const preElement = codeBlock.parentElement;
                const mermaidCode = codeBlock.textContent;
                
                try {
                    // Create a unique ID for this diagram
                    const id = `mermaid-${Date.now()}-${i}`;
                    
                    // Create a div to hold the rendered diagram
                    const mermaidDiv = document.createElement('div');
                    mermaidDiv.className = 'mermaid';
                    mermaidDiv.id = id;
                    mermaidDiv.textContent = mermaidCode;
                    
                    // Replace the pre/code block with the mermaid div
                    preElement.replaceWith(mermaidDiv);
                    
                    // Render this specific diagram
                    await mermaid.run({
                        nodes: [mermaidDiv]
                    });
                } catch (e) {
                    console.error('Mermaid rendering error:', e);
                    // Keep the original code block if rendering fails
                }
            }
        }

        textarea.addEventListener('input', updatePreview);
        updatePreview();

        // Ensure Mermaid diagrams are rendered before printing
        let isRenderingMermaid = false;
        
        window.addEventListener('beforeprint', async (e) => {
            if (isRenderingMermaid) return;
            
            // Check if there are any mermaid divs that need rendering
            const mermaidDivs = preview.querySelectorAll('.mermaid:not([data-processed])');
            if (mermaidDivs.length > 0) {
                isRenderingMermaid = true;
                try {
                    await mermaid.run({ nodes: Array.from(mermaidDivs) });
                } catch (e) {
                    console.error('Print preparation error:', e);
                }
                isRenderingMermaid = false;
            }
        });
        
        async function downloadPDF() {
            // Ensure all diagrams are rendered before opening print dialog
            const unrenderedMermaid = preview.querySelectorAll('.mermaid:not([data-processed])');
            if (unrenderedMermaid.length > 0) {
                await mermaid.run({ nodes: Array.from(unrenderedMermaid) });
                // Small delay to ensure DOM is updated
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            window.print();
        }
    </script>
</body>
</html>
